---
title: "PCA"
output:
  html_document:
    df_print: paged
---

https://satijalab.org/seurat/articles/pbmc3k_tutorial.html

```{r}
library(readr)
EZ_Batch1 <- read_csv("EZ_Batch1.csv")
EZ_Batch1<-as.data.frame(EZ_Batch1)

```
```{r}
head(EZ_Batch1)
```


```{r}
library(Seurat)
```
```{r}
colnames(EZ_Batch1)[1] <- "gene"
rownames(EZ_Batch1) <- EZ_Batch1$gene
EZ_Batch1$gene <- NULL
head(EZ_Batch1)

```


```{r}
library(data.table)


# transpose
tez <- transpose(EZ_Batch1)

# get row and colnames in order
colnames(tez) <- rownames(EZ_Batch1)
rownames(tez) <- colnames(EZ_Batch1)

```

```{r}
obj <- CreateSeuratObject(counts=tez, project="EZ_batch1", min.cells = 3, min.features = 200)
obj
```
```{r}
obj[["percent.mt"]] <- PercentageFeatureSet(obj, pattern = "^MT-")
```

```{r}
VlnPlot(obj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
```
```{r}

plot1 <- FeatureScatter(obj, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1
plot2
```
```{r}
obj <- subset(obj, subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5)
obj <- NormalizeData(obj, normalization.method = "LogNormalize", scale.factor = 10000)
```
```{r}
obj <- FindVariableFeatures(obj, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(obj), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(obj)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1
plot2
```
```{r}
all.genes <- rownames(obj)
obj <- ScaleData(obj, features = all.genes)
```
```{r}
obj <- RunPCA(obj, features = VariableFeatures(object = obj))
print(obj[["pca"]], dims = 1:5, nfeatures = 5)
```

```{r}
DimPlot(obj, reduction = "pca")
```
```{r}
DimHeatmap(obj, dims = 1, cells = 500, balanced = TRUE)
```
```{r}
ElbowPlot(obj)
```

```{r}
obj <- FindNeighbors(obj, dims = 1:10)
obj <- FindClusters(obj, resolution = 0.5)
```


```{r}
head(Idents(obj), 5)
```


```{r}
obj <- RunUMAP(obj, dims = 1:20)
DimPlot(obj, reduction = "umap")

```
```{r}
saveRDS(obj, file = "ez1.rds")

```

```{r}
# find all markers of cluster 2

cluster2.markers <- FindMarkers(obj, ident.1 = 2, min.pct = 0.15)
head(cluster2.markers, n = 5)
```

